#!/usr/bin/with-contenv bash

#======================================================================================================================
# Clean directories
#======================================================================================================================

WP=/wp
WWW=/www
WP_CONTENT=${WWW}/wp-content

echo " - deleting contents of ${WWW} and ${WP}..."
rm -rf ${WWW}/* ${WP}/*
echo " - done."


#======================================================================================================================
# Download WordPress
#======================================================================================================================

cd /tmp

URL="https://${WORDPRESS_LOCALE}.wordpress.org/latest-${WORDPRESS_LOCALE}.zip"
echo " - downloading ${URL}..."
wget -O wp.zip ${URL}
unzip -q wp.zip
rm wp.zip

if [ -d ./wordpress ] ; then
    echo " - done."
else
    echo " - error."
    exit 1
fi


#======================================================================================================================
# Move WordPress files to /www
#======================================================================================================================

echo " - moving WordPress files to ${WWW}..."
mv wordpress/* ${WWW}
rm -rf wordpress
echo " - done."


#======================================================================================================================
# Move wp-content files and create symlinks
#======================================================================================================================

function move_and_link () {
    # define directory variables
    WP_DIR=${WP}/${1}
    WP_CONTENT_DIR=${WP_CONTENT}/${1}

    # if dir does not exist in /etc/wp, create it
    if [ ! -d ${WP_DIR} ] ; then
        mkdir -p ${WP_DIR}

        # if dir exists in /var/www/localhost/wp-content, move contents
        if [ -d ${WP_CONTENT_DIR} ] ; then
            mv ${WP_CONTENT_DIR}/* ${WP_DIR}
        fi
    fi

    # if dir exists in /var/www/localhost/wp-content, delete it
    if [ -d ${WP_CONTENT_DIR} ] ; then
        rm -rf ${WP_CONTENT_DIR}
    fi

    # create link from /etc/wp to /var/www/localhost/wp-content
    ln -s ${WP_DIR} ${WP_CONTENT_DIR}
}

echo " - linking wp-config.php..."
ln -s ${WP}/wp-config.php ${WWW}/wp-config.php
echo " - done."

echo " - moving wp-content directories and linking..."
move_and_link "plugins"
move_and_link "themes"
move_and_link "uploads"
echo " - done."
