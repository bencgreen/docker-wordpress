#!/usr/bin/with-contenv bash

#======================================================================================================================
# Download WordPress
#======================================================================================================================

cd /tmp

URL="https://${WORDPRESS_LOCALE}.wordpress.org/latest-${WORDPRESS_LOCALE}.zip"
echo " - downloading ${URL}..."
wget -O wp.zip ${URL}
unzip -q wp.zip && rm wp.zip

if [ -d ./wordpress ] ; then
    echo " - done."
else
    echo " - error."
    exit 1
fi


#======================================================================================================================
# Move WordPress files to /var/www/localhost
#======================================================================================================================

echo " - moving WordPress files to /var/www/localhost..."
mv wordpress/* /var/www/localhost/ && rm -rf wordpress
echo " - done."


#======================================================================================================================
# Move wp-content files and create symlinks
#======================================================================================================================

WP=/etc/wp
WWW=/var/www/localhost
WP_CONTENT=${WWW}/wp-content

function move_and_link () {
    # if dir does not exist in /etc/wp, create it
    if [ ! -d ${WP}/$1 ] ; then
        mkdir ${WP}/$1
    fi

    # if dir exists in /var/www/localhost/wp-content, move contents and delete it
    if [ -d ${WP_CONTENT}/$1 ] ; then
        mv ${WP_CONTENT}/$1/* ${WP}/$1/
        rm -rf ${WP_CONTENT}/$1
    fi

    # create link from /etc/wp to /var/www/localhost/wp-content
    ln -s ${WP}/$1 ${WP_CONTENT}/$1
}

echo " - linking wp-config.php..."
ln -s ${WP}/wp-config.php ${WWW}/wp-config.php
echo " - done."

echo " - moving wp-content directories and linking..."
move_and_link "plugins"
move_and_link "themes"
move_and_link "uploads"
echo " - done."
