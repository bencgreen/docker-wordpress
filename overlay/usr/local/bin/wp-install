#!/usr/bin/with-contenv bash

#======================================================================================================================
# Download WordPress
#======================================================================================================================

cd /tmp

URL="https://${WORDPRESS_LOCALE}.wordpress.org/latest-${WORDPRESS_LOCALE}.zip"
echo " - downloading ${URL}..."
wget -O wp.zip ${URL}
unzip -q wp.zip && rm wp.zip

if [ -d ./wordpress ] ; then
    echo " - done."
else
    echo " - error."
    exit 1
fi


#======================================================================================================================
# Move WordPress files to /var/www/localhost
#======================================================================================================================

echo " - moving WordPress files to /var/www/localhost..."
mv wordpress/* /var/www/localhost/ && rm -rf wordpress
echo " - done."


#======================================================================================================================
# Move wp-content files and create symlinks
#======================================================================================================================

DIR_WP=/etc/wp
DIR_WWW=/var/www/localhost
DIR_CONTENT=${DIR_WWW}/wp-content

echo " - creating wp-config.php and linking..."
touch ${DIR_WP}/wp-config.php \
    && ln -s ${DIR_WP}/wp-config.php ${DIR_WWW}/wp-config.php
echo " - done."

echo " - moving wp-content directories and linking..."
move_and_link "plugins"
move_and_link "themes"
move_and_link "uploads"
echo " - done."

function move_and_link () {
    if [ ! -d ${DIR_WP}/$1 ] ; then
        mkdir ${DIR_WP}/$1
    fi

    mv ${DIR_CONTENT}/$1/* ${DIR_WP}/
    rm -rf ${DIR_CONTENT}/$1

    ln -s ${DIR_WP}/$1 ${DIR_CONTENT}/$1
}
