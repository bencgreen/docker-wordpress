#!/usr/bin/with-contenv bash

set -euo pipefail
export BCG_E=`basename ${0}`


#======================================================================================================================
# Move all wp-content content to /wp and create a link.
#
# Arguments
#   1   Name of content file or directory
#======================================================================================================================

function move-content () {

    # helpful output
    bcg-echo " .. ${1}"

    # define content variables
    IN_WP="${WP_CONTENT}/${1}"
    IN_WWW="${NGINX_WWW_WP_CONTENT}/${1}"

    # if content does not exist in /wp, create it and set ownership
    if [ ! -e ${IN_WP} ] ; then
        bcg-debug "    moving ${IN_WWW} to ${IN_WP}"
        mv ${IN_WWW} ${WP_CONTENT}/
    else
        bcg-debug "    ${IN_WP} already exists."
    fi

}

bcg-echo "Moving wp-content directories and linking..."
for CONTENT in ${NGINX_WWW_WP_CONTENT}/* ; do

    # get file name
    NAME=$(basename -- "${CONTENT}")

    # move content
    move-content "${NAME}"

done
bcg-done


#======================================================================================================================
# Move /wp/* to /wp/content/.
#======================================================================================================================

bcg-echo "Moving any additional content into ${WP_CONTENT}..."
for CONTENT in ${WP_ROOT}/* ; do

    # get file name
    NAME=$(basename -- "${CONTENT}")

    case "${NAME}" in

        content|wp-config.php)
            bcg-debug " .. ignoring ${CONTENT}."
            continue;
            ;;

        *)
            bcg-debug " .. moving ${CONTENT}"
            mv "${CONTENT}" ${WP_CONTENT}/
            ;;

    esac

done
bcg-done


#======================================================================================================================
# Delete www/wp-content and link to wp/content.
#======================================================================================================================

bcg-echo "Removing /www/wp-content and linking to /wp/content..."
bcg-rmrf "${NGINX_WWW_WP_CONTENT}"
ln -s ${WP_CONTENT} ${NGINX_WWW_WP_CONTENT}
bcg-done
