#!/usr/bin/with-contenv bash

set -euo pipefail
export BCG_E=`basename ${0}`


#======================================================================================================================
# Move all files and directories in /www/wp-content to /wp/content.
#======================================================================================================================

bcg-echo "Moving ${NGINX_WWW_WP_CONTENT} files and directories..."
for CONTENT in ${NGINX_WWW_WP_CONTENT}/* ; do

    # get file name
    NAME=$(basename -- "${CONTENT}")
    bcg-echo " .. ${NAME}"

    # define content variables
    IN_WP="${WP_CONTENT}/${NAME}"
    IN_WWW="${NGINX_WWW_WP_CONTENT}/${NAME}"

    # if content does not exist in /wp, create it and set ownership
    if [ -e ${CONTENT} ] && [ ! -e ${IN_WP} ] ; then
        bcg-debug "    moving ${IN_WWW} to ${IN_WP}"
        mv ${IN_WWW} ${WP_CONTENT}
    else
        bcg-debug "    ${IN_WP} already exists."
    fi

done
bcg-done


#======================================================================================================================
# Move any additional files in /wp/ to /wp/content/ (supports previous versions of the image).
#======================================================================================================================

bcg-echo "Moving any additional content into ${WP_CONTENT}..."
for CONTENT in ${WP_ROOT}/* ; do

    # get file name
    NAME=$(basename -- "${CONTENT}")

    case "${NAME}" in

        content|wp-config.php)
            bcg-debug " .. ignoring ${CONTENT}."
            continue;
            ;;

        *)
            bcg-debug " .. moving ${CONTENT}"
            mv "${CONTENT}" ${WP_CONTENT}/
            ;;

    esac

done
bcg-done


#======================================================================================================================
# Delete /www/wp-content and link to /wp/content.
#======================================================================================================================

bcg-echo "Removing ${NGINX_WWW_WP_CONTENT}and linking to ${WP_CONTENT}..."
bcg-rmrf "${NGINX_WWW_WP_CONTENT}"
bcg-debug "Creating link to ${WP_CONTENT}."
ln -s ${WP_CONTENT} ${NGINX_WWW_WP_CONTENT}
bcg-done
