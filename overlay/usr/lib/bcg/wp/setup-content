#!/usr/bin/with-contenv bash

set -euo pipefail
export BCG_E=`basename ${0}`


#======================================================================================================================
# Move all wp-content content to /wp and create a link.
#
# Arguments
#   1   Name of content file or directory
#======================================================================================================================

function move_and_link () {

    # helpful output
    bcg-echo " .. ${1}"

    # define content variables
    IN_WP="${WP_CONTENT}/${1}"
    IN_WWW="${NGINX_WWW_WP_CONFIG}/${1}"

    # if content does not exist in /wp, create it and set ownership
    if [ ! -e ${IN_WP} ] ; then
        mkdir -p ${IN_WP} && chown www:www ${IN_WP}

        # if content exists in /www/wp-content move contents
        if [ -e ${IN_WWW} ] ; then
            bcg-debug "    moving contents from ${IN_WWW} to ${IN_WP}"
            mv ${IN_WWW}/* ${IN_WP}
        fi

    fi

    # check link from /www/wp-content/* directory to /wp/* directory
    if [ ! -L ${IN_WWW} ] ; then

        # if content exists in /www/wp-content, delete it
        if [ -e ${IN_WWW} ] ; then
            bcg-debug "    deleting directory ${IN_WWW}"
            bcg-rmrf "${IN_WWW}" > /dev/null 2>&1
        fi

        # create link from /wp to /www/wp-content
        bcg-debug "    creating link from ${IN_WP} to ${IN_WWW}"
        ln -s ${IN_WP} ${IN_WWW}

    fi

}

bcg-echo "Moving wp-content directories and linking..."
for CONTENT in ${NGINX_WWW_WP_CONTENT}/* ; do
    move_and_link "${CONTENT}"
done
bcg-done


#======================================================================================================================
# Move /wp/* to /wp/content/.
#======================================================================================================================

bcg-echo "Moving additional content into ${WP_CONTENT}..."
for CONTENT in ${WP_ROOT}/* ; do

    case "${CONTENT}" in

        content|wp-config.php)
            bcg-debug "Leave content/ and wp-config.php."
            continue;
            ;;

        *)
            bcg-debug "Moving ${CONTENT}."
            mv "${WP_ROOT}/${CONTENT}" ${WP_CONTENT}/
            ;;

    esac

done
bcg-done


#======================================================================================================================
# Delete www/wp-content and link to wp/content.
#======================================================================================================================

#bcg-rmrf "${NGINX_WWW_WP_CONTENT}"

#bcg-echo "Linking ${NGINX_WWW_WP_CONTENT} to ${WP_CONTENT}..."
#ln -s ${NGINX_WWW_WP_CONTENT} ${WP_CONTENT}
#bcg-done
